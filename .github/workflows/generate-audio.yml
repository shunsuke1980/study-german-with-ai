name: Generate Audio with Google Cloud TTS

on:
  push:
    paths:
      - 'blog/**'
    branches:
      - main

jobs:
  generate-audio:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        pip install google-cloud-texttospeech

    - name: Set up Google Cloud credentials
      run: |
        echo '${{ secrets.GOOGLE_CLOUD_SERVICE_ACCOUNT_KEY }}' > /tmp/gcp-key.json
        export GOOGLE_APPLICATION_CREDENTIALS=/tmp/gcp-key.json

    - name: Generate audio files for German content only
      env:
        GOOGLE_APPLICATION_CREDENTIALS: /tmp/gcp-key.json
      run: |
        python << 'EOF'
        import os
        import random
        import re
        from pathlib import Path
        from google.cloud import texttospeech

        # ãƒ‰ã‚¤ãƒ„èªéŸ³å£°ã®é¸æŠè‚¢ï¼ˆ4ã¤ï¼‰
        GERMAN_VOICES = [
            {"name": "de-DE-Standard-A", "gender": texttospeech.SsmlVoiceGender.FEMALE},
            {"name": "de-DE-Standard-B", "gender": texttospeech.SsmlVoiceGender.MALE},
            {"name": "de-DE-Wavenet-A", "gender": texttospeech.SsmlVoiceGender.FEMALE},
            {"name": "de-DE-Wavenet-B", "gender": texttospeech.SsmlVoiceGender.MALE}
        ]

        # Google Cloud TTS ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–
        client = texttospeech.TextToSpeechClient()

        # éŸ³å£°è¨­å®š
        audio_config = texttospeech.AudioConfig(
            audio_encoding=texttospeech.AudioEncoding.MP3
        )

        # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
        import subprocess
        result = subprocess.run(
            ["git", "diff", "--name-only", "HEAD~1", "HEAD"],
            capture_output=True,
            text=True
        )

        changed_files = [f for f in result.stdout.strip().split('\n') if f.startswith('blog/')]

        # ãƒ¡ã‚¤ãƒ³ã®ãƒ‰ã‚¤ãƒ„èªè¨˜äº‹ã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        german_files = []
        for file_path in changed_files:
            if not file_path or not os.path.exists(file_path):
                continue

            # ãƒ•ã‚¡ã‚¤ãƒ«åãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
            filename = Path(file_path).name

            # é™¤å¤–ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼š
            # - æ—¥æœ¬èªè§£èª¬: *-jp.md
            # - è‹±èªè§£èª¬: *-en.md
            # - é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ: *weekly*.md
            if (filename.endswith('-jp.md') or
                filename.endswith('-en.md') or
                'weekly' in filename.lower() or
                'report' in filename.lower()):
                print(f"Skipping non-German file: {file_path}")
                continue

            # YYYY-MM-DD.md ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ãƒ¡ã‚¤ãƒ³ãƒ‰ã‚¤ãƒ„èªè¨˜äº‹ã®ã¿å‡¦ç†
            if re.match(r'^\d{4}-\d{2}-\d{2}\.md$', filename):
                german_files.append(file_path)
                print(f"German article detected: {file_path}")

        if not german_files:
            print("No German articles found for audio generation")
            exit(0)

        # assets/audio ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
        audio_dir = Path("assets/audio")
        audio_dir.mkdir(parents=True, exist_ok=True)

        for file_path in german_files:
            print(f"Processing German article: {file_path}")

            # ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’èª­ã¿å–ã‚Š
            with open(file_path, 'r', encoding='utf-8') as f:
                content = f.read()

            # YAMLãƒ•ãƒ­ãƒ³ãƒˆãƒã‚¿ãƒ¼ã‚’é™¤å»
            if content.startswith('---'):
                # æœ€åˆã® --- ã‹ã‚‰æ¬¡ã® --- ã¾ã§ã‚’é™¤å»
                parts = content.split('---', 2)
                if len(parts) >= 3:
                    content = parts[2]

            # ãƒ‰ã‚¤ãƒ„èªãƒ†ã‚­ã‚¹ãƒˆéƒ¨åˆ†ã®ã¿ã‚’æŠ½å‡º
            lines = content.split('\n')
            german_text_lines = []

            for line in lines:
                line = line.strip()
                if not line:
                    continue

                # çµ±è¨ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ä»¥é™ã¯é™¤å¤–
                if line.startswith('**ğŸ“š A2-Lernfortschritt:**'):
                    break
                if line.startswith('**ğŸ“Š Tagesstatistiken:**'):
                    break
                if line.startswith('**ğŸ¯ Neue A2-Vokabeln heute:**'):
                    break
                if line.startswith('**ğŸ“– Sprachhilfen'):
                    break
                if line.startswith('---'):
                    break

                # ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³è¨˜å·ã‚’é™¤å»
                if (not line.startswith('#') and
                    not line.startswith('*') and
                    not line.startswith('-') and
                    not line.startswith('|') and
                    not line.startswith('>')):
                    german_text_lines.append(line)

            # ãƒ‰ã‚¤ãƒ„èªãƒ†ã‚­ã‚¹ãƒˆã‚’çµåˆ
            german_text = ' '.join(german_text_lines).strip()

            # ãƒªãƒ³ã‚¯ãƒ†ã‚­ã‚¹ãƒˆã‚’é™¤å»
            german_text = re.sub(r'\[([^\]]*)\]\([^\)]*\)', r'\1', german_text)

            # ä½™åˆ†ãªç©ºç™½ã‚’é™¤å»
            german_text = re.sub(r'\s+', ' ', german_text).strip()

            if not german_text or len(german_text) < 50:
                print(f"No sufficient German content found in {file_path}")
                continue

            print(f"Extracted German text length: {len(german_text)} characters")
            print(f"Text preview: {german_text[:100]}...")

            # ãƒ©ãƒ³ãƒ€ãƒ ã«éŸ³å£°ã‚’é¸æŠ
            selected_voice = random.choice(GERMAN_VOICES)
            print(f"Selected voice: {selected_voice['name']}")

            # éŸ³å£°åˆæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ
            synthesis_input = texttospeech.SynthesisInput(text=german_text)
            voice = texttospeech.VoiceSelectionParams(
                language_code="de-DE",
                name=selected_voice["name"],
                ssml_gender=selected_voice["gender"]
            )

            # TTS APIå‘¼ã³å‡ºã—
            try:
                response = client.synthesize_speech(
                    input=synthesis_input,
                    voice=voice,
                    audio_config=audio_config
                )

                # å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆï¼ˆæ—¥ä»˜éƒ¨åˆ†ã®ã¿ä½¿ç”¨ï¼‰
                file_stem = Path(file_path).stem
                output_file = audio_dir / f"{file_stem}.mp3"

                # éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜
                with open(output_file, "wb") as out:
                    out.write(response.audio_content)

                print(f"âœ… Audio saved: {output_file}")

            except Exception as e:
                print(f"âŒ Error generating audio for {file_path}: {e}")

        print("Audio generation completed")
        EOF

    - name: Commit and push audio files
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action TTS"
        git add assets/audio/*.mp3
        if git diff --staged --quiet; then
          echo "No audio files to commit"
        else
          git commit -m "Add generated German audio files [skip ci]"
          git push
        fi

    - name: Clean up credentials
      if: always()
      run: |
        rm -f /tmp/gcp-key.json